{% extends 'base.html' %}
{% load static %}

{% block title %}Finalizar Compra | ModaOne{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-7">
            
            <h4 class="mb-3 fw-bold text-uppercase ls-1">1. Datos de Contacto</h4>
            <div class="card border-0 shadow-sm mb-5">
                <div class="card-body bg-light">
                    <label class="form-label fw-bold small text-muted">Enviar boleta y notificaciones a:</label>
                    <input type="email" name="email_contacto" value="{{ request.user.email }}" 
                           class="form-control" placeholder="tu@correo.com" required 
                           form="form-generar-orden">
                    <div class="form-text">Te enviaremos el comprobante PDF aquí.</div>
                </div>
            </div>

            <h4 class="mb-3 fw-bold text-uppercase ls-1">2. Dirección de Envío</h4>
            <div class="row mb-4">
                {% for dir in direcciones_guardadas %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100 border-0 shadow-sm {% if dir.predeterminada %}border-primary{% endif %}">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="direccion_id" value="{{ dir.id }}" id="dir-{{ dir.id }}" form="form-generar-orden" required {% if dir.predeterminada %}checked{% endif %}>
                                <label class="form-check-label w-100" for="dir-{{ dir.id }}">
                                    <strong class="d-block text-dark">{{ dir.calle }} #{{ dir.numero }}</strong>
                                    <span class="text-muted small">{{ dir.comuna }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                    <div class="alert alert-warning">No tienes direcciones. Agrega una abajo.</div>
                {% endfor %}
            </div>

            <div class="card border-0 bg-white shadow-sm mb-5">
                <div class="card-body">
                    <h6 class="fw-bold mb-3"><i class="fas fa-plus"></i> Nueva Dirección</h6>
                    <form method="post">
                        {% csrf_token %}
                        <div class="row g-2">
                            <div class="col-6">{{ direccion_form.rut }}</div>
                            <div class="col-6">{{ direccion_form.telefono }}</div>
                            <div class="col-12">{{ direccion_form.calle }}</div>
                            <div class="col-4">{{ direccion_form.numero }}</div>
                            <div class="col-8">{{ direccion_form.comuna }}</div>
                            <div class="col-12">
                                <div class="form-check">
                                    {{ direccion_form.predeterminada }}
                                    <label class="form-check-label small">Guardar como principal</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-dark btn-sm mt-3">Guardar Dirección</button>
                    </form>
                </div>
            </div>

            <h4 class="mb-3 fw-bold text-uppercase ls-1">3. Método de Entrega</h4>
            <div class="d-flex flex-column gap-2 mb-5">
                {% for envio in costos_envio %}
                <label class="card border-0 shadow-sm p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <input type="radio" name="metodo_envio" value="{{ envio.id }}" class="form-check-input me-2" form="form-generar-orden" required>
                            <span class="fw-bold">{{ envio.nombre }}</span>
                        </div>
                        <span class="fw-bold">${{ envio.costo|floatformat:0 }}</span>
                    </div>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card border-0 shadow-lg sticky-top" style="top: 2rem;">
                <div class="card-header bg-black text-white py-3 text-center fw-bold">RESUMEN DEL PEDIDO</div>
                <div class="card-body p-4">
                    {% for item in items %}
                    <div class="d-flex justify-content-between mb-2 small">
                        <span>{{ item.cantidad }}x {{ item.variante.producto.nombre }}</span>
                        <span class="fw-bold">${{ item.subtotal|floatformat:0 }}</span>
                    </div>
                    {% endfor %}
                    <hr>
                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <span>Subtotal</span>
                        <span>${{ subtotal|floatformat:0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-4">
                        <span class="h5 fw-bold">Total a Pagar</span>
                        <span class="h4 fw-bold text-dark" id="total-display">${{ subtotal|floatformat:0 }}</span>
                    </div>

                    <form action="{% url 'generar_orden' %}" method="POST" id="form-generar-orden">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success w-100 py-3 fw-bold text-uppercase">
                            CONFIRMAR Y PAGAR
                        </button>
                    </form>
                    <p class="text-center mt-2 small text-muted">Pago procesado de forma segura.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const subtotal = parseFloat("{{ subtotal|stringformat:'d' }}") || 0;    const radios = document.querySelectorAll('input[name="metodo_envio"]');
    const totalDisplay = document.getElementById('total-display');
    const costos = { 1: 5990, 2: 3990 };

    radios.forEach(r => {
        r.addEventListener('change', function() {
            const costo = costos[this.value] || 0;
            const total = subtotal + costo;
            totalDisplay.innerText = '$' + total.toLocaleString('es-CL');
        });
    });
</script>
{% endblock %}