{% extends 'base_admin.html' %}

{% block title %}Cartera de Clientes | ModaOne{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-4 border-bottom">
    <div>
        <h1 class="h2 fw-bold"><i class="fas fa-users me-2"></i>Inteligencia de Clientes</h1>
        <p class="text-muted mb-0">SegmentaciÃ³n automÃ¡tica basada en IA y Comportamiento de Compra.</p>
    </div>
    <button class="btn btn-dark" onclick="window.print()"><i class="fas fa-file-export me-2"></i>Reporte</button>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm border-start border-4 border-info h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small ls-1">Usuarios VIP</h6>
                <h3>{{ clientes|length }} <small class="fs-6 text-muted">activos</small></h3>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="alert alert-light border shadow-sm h-100 d-flex align-items-center mb-0">
            <i class="fas fa-robot fa-2x text-warning me-3"></i>
            <div>
                <strong>Insight de Mercado (IA):</strong>
                <p class="mb-0 small text-muted">El sistema detecta automÃ¡ticamente a usuarios "Curiosos" (que usan el <strong>Probador Virtual</strong> pero no compran), permitiÃ©ndote enviar ofertas dirigidas para cerrar la venta.</p>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-uppercase small fw-bold text-muted">
                    <tr>
                        <th class="ps-4">Cliente</th>
                        <th class="text-center">Perfil (Scoring)</th>
                        <th class="text-center">InteracciÃ³n IA</th>
                        <th class="text-center">Historial Ventas</th>
                        <th class="text-end pe-4">AcciÃ³n de Marketing</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in clientes %}
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="bg-dark text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; font-weight: bold;">
                                    {{ c.usuario.first_name|slice:":1" }}{{ c.usuario.last_name|slice:":1" }}
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">{{ c.usuario.first_name }} {{ c.usuario.last_name }}</div>
                                    <div class="small text-muted">{{ c.usuario.email }}</div>
                                    {% if c.telefono %}
                                        <div class="small text-secondary"><i class="fas fa-phone me-1"></i>{{ c.telefono }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <td class="text-center">
                            <span class="badge bg-{{ c.color }} text-dark border border-{{ c.color }} px-3 py-1 rounded-pill">
                                {{ c.perfil }}
                            </span>
                            {% if c.dias_inactivo %}
                                <div class="small text-muted mt-1">Hace {{ c.dias_inactivo }} dÃ­as no compra</div>
                            {% endif %}
                        </td>

                        <td class="text-center" style="width: 20%;">
                            {% if c.uso_ia > 0 %}
                                <div class="d-flex justify-content-between small mb-1">
                                    <span class="fw-bold text-primary">{{ c.uso_ia }} pruebas</span>
                                    <span class="text-muted">InterÃ©s</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-primary" role="progressbar" 
                                         style="width: {{ c.porcentaje_ia|default:'0' }}%;" 
                                         aria-valuenow="{{ c.porcentaje_ia|default:'0' }}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            <div class="fw-bold">${{ c.gasto|floatformat:"0" }}</div>
                            <div class="small text-muted">{{ c.ordenes }} Pedidos</div>
                        </td>

                        <td class="text-end pe-4">
                            {% if c.telefono %}
                                {% if c.perfil == "ðŸ’Ž VIP" %}
                                    <a href="https://wa.me/569{{ c.telefono|slice:'-8:' }}?text=Hola%20{{ c.usuario.first_name }},%20eres%20uno%20de%20nuestros%20mejores%20clientes%20en%20ModaOne!%20Te%20tenemos%20un%20regalo%20especial." target="_blank" class="btn btn-sm btn-outline-info w-100 fw-bold">
                                        <i class="fab fa-whatsapp me-1"></i> Tratar como VIP
                                    </a>
                                {% elif c.perfil == "ðŸ‘€ Curioso (IA)" %}
                                    <a href="https://wa.me/569{{ c.telefono|slice:'-8:' }}?text=Hola%20{{ c.usuario.first_name }},%20vimos%20que%20probaste%20ropa%20en%20nuestro%20espejo%20virtual.%20Â¿Te%20gustarÃ­a%20un%205%25%20de%20descuento%20para%20animarte?" target="_blank" class="btn btn-sm btn-warning text-dark w-100 fw-bold">
                                        <i class="fab fa-whatsapp me-1"></i> Convertir Venta
                                    </a>
                                {% elif c.perfil == "ðŸ‘» Inactivo" %}
                                    <a href="https://wa.me/569{{ c.telefono|slice:'-8:' }}?text=Hola%20{{ c.usuario.first_name }},%20te%20extraÃ±amos%20en%20ModaOne.%20Mira%20la%20nueva%20colecciÃ³n!" target="_blank" class="btn btn-sm btn-outline-danger w-100 fw-bold">
                                        <i class="fab fa-whatsapp me-1"></i> Recuperar
                                    </a>
                                {% else %}
                                    <a href="mailto:{{ c.usuario.email }}" class="btn btn-sm btn-light border w-100">Contactar</a>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-light text-muted border">Sin Contacto</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center py-5">AÃºn no hay clientes registrados.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}