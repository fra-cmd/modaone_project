{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Reportes BI | ModaOne{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Reportes de Inteligencia de Negocios</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'reporte_bi' %}" target="_blank" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-file-pdf"></i> Exportar PDF
            </a>
            <a href="{% url 'dashboard_expansion' %}" class="btn btn-sm btn-primary ms-2">
    <i class="fas fa-chart-line"></i> Ver Estrategia y Expansión
</a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary mb-3 shadow-sm h-100">
            <div class="card-header">Ventas Totales</div>
            <div class="card-body">
                <h3 class="card-title" id="bi-ventas">$0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success mb-3 shadow-sm h-100">
            <div class="card-header">Pedidos Exitosos</div>
            <div class="card-body">
                <h3 class="card-title" id="bi-ordenes">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning text-dark mb-3 shadow-sm h-100">
            <div class="card-header">Ticket Promedio</div>
            <div class="card-body">
                <h3 class="card-title" id="bi-ticket">$0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger mb-3 shadow-sm h-100">
            <div class="card-header">Stock Crítico</div>
            <div class="card-body">
                <h3 class="card-title" id="bi-stock">0</h3>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header fw-bold">
                <i class="fas fa-chart-bar me-1"></i> Top 5 Productos Más Vendidos
            </div>
            <div class="card-body">
                <canvas id="chartVentas" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header fw-bold">
                <i class="fas fa-chart-pie me-1"></i> Estado de Pedidos
            </div>
            <div class="card-body">
                <canvas id="chartEstados"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-5">
    <div class="card-header fw-bold">
        <i class="fas fa-eye me-1"></i> Interés de Clientes (Datos del Probador Virtual)
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Producto</th>
                    <th class="text-center">Veces Probado</th>
                    <th class="text-center">Ventas Reales</th>
                    <th class="text-end">Tasa de Conversión (Estimada)</th>
                </tr>
            </thead>
            <tbody id="tabla-tryon">
                <tr><td colspan="4" class="text-center py-3">Cargando análisis...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        cargarDatosBI();
    });

    async function cargarDatosBI() {
        try {
            const response = await fetch('/api/v1/dashboard-kpi/');
            
            if (response.ok) {
                const data = await response.json();
                
                // 1. Llenar KPIs (Tarjetas de colores)
                document.getElementById('bi-ventas').innerText = '$' + parseInt(data.total_ventas).toLocaleString('es-CL');
                document.getElementById('bi-ordenes').innerText = data.total_ordenes;
                document.getElementById('bi-stock').innerText = data.bajo_stock;
                
                const ticket = data.total_ordenes > 0 ? Math.round(data.total_ventas / data.total_ordenes) : 0;
                document.getElementById('bi-ticket').innerText = '$' + ticket.toLocaleString('es-CL');

                // 2. Gráfico de Ventas (Si hay datos)
                if (data.top_productos && data.top_productos.length > 0) {
                    const ctxVentas = document.getElementById('chartVentas').getContext('2d');
                    new Chart(ctxVentas, {
                        type: 'bar',
                        data: {
                            labels: data.top_productos.map(p => p.nombre_producto),
                            datasets: [{
                                label: 'Unidades Vendidas',
                                data: data.top_productos.map(p => p.total_vendido),
                                backgroundColor: '#0d6efd',
                                borderRadius: 4
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { display: false } } }
                    });
                }

                // 3. Gráfico de Estados (Estático por ahora, para visualización)
                const ctxEstados = document.getElementById('chartEstados').getContext('2d');
                new Chart(ctxEstados, {
                    type: 'doughnut',
                    data: {
                        labels: ['Entregado', 'En Despacho', 'Confirmado', 'Pendiente'],
                        datasets: [{
                            data: [data.total_ordenes, 2, 1, 0], // Ejemplo visual dinámico
                            backgroundColor: ['#198754', '#0dcaf0', '#ffc107', '#6c757d']
                        }]
                    }
                });
                
                // 4. Llenar Tabla Try-On (CON DATOS REALES AHORA)
                const tbody = document.getElementById('tabla-tryon');
                tbody.innerHTML = '';
                
                if (data.top_tryon && data.top_tryon.length > 0) {
                    data.top_tryon.forEach(item => {
                        // Usamos los datos que calculó Python
                        const conversion = item.tasa_conversion;
                        
                        // Lógica de colores para el negocio
                        let color = 'text-muted';
                        if(conversion >= 20) color = 'text-success fw-bold'; // ¡Éxito!
                        if(conversion < 5) color = 'text-danger fw-bold';    // ¡Alerta! Se prueba mucho pero no se vende
                        
                        tbody.innerHTML += `
                            <tr>
                                <td>${item.producto__nombre}</td>
                                <td class="text-center fw-bold">${item.veces_probado}</td>
                                <td class="text-center">${item.ventas_reales}</td>
                                <td class="text-end ${color}">${conversion}%</td>
                            </tr>
                        `;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">Aún no hay pruebas en el Probador Virtual.</td></tr>';
                }
            }
        } catch (error) {
            console.error("Error cargando BI:", error);
        }
    }
</script>
{% endblock %}
