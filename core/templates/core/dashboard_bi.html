{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Inteligencia de Negocios | ModaOne{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard de Inteligencia (BI)</h1>
    
    <div class="btn-toolbar mb-2 mb-md-0">
        <select id="filtroPeriodo" class="form-select form-select-sm me-2" onchange="cargarDatosBI()">
            <option value="historico">Todo el Histórico</option>
            <option value="anio">Este Año</option>
            <option value="trimestre">Último Trimestre</option>
            <option value="mes" selected>Último Mes</option>
            <option value="semana">Última Semana</option>
        </select>
        <button class="btn btn-sm btn-outline-primary" onclick="cargarDatosBI()">
            <i class="fas fa-sync"></i> Actualizar
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card text-white bg-primary mb-3 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Ventas del Periodo</h5>
                <h2 id="bi-ventas">$0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-white bg-success mb-3 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Pedidos Totales</h5>
                <h2 id="bi-pedidos">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm h-100">
            <div class="card-header fw-bold">
                <i class="fas fa-trophy me-1"></i> Lo más vendido (Top 5)
            </div>
            <div class="card-body">
                <canvas id="chartVentas"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header fw-bold">
                <i class="fas fa-chart-pie me-1"></i> Estados de Pedidos
            </div>
            <div class="card-body">
                <canvas id="chartEstados"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header fw-bold text-white bg-dark">
                <i class="fas fa-snowflake me-1"></i> vs <i class="fas fa-sun me-1"></i> Análisis Estacional
            </div>
            <div class="card-body">
                <p class="small text-muted">Comparativa histórica de volumen de ventas.</p>
                <canvas id="chartEstaciones"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm h-100 border-warning">
            <div class="card-header fw-bold bg-warning text-dark">
                <i class="fas fa-brain me-1"></i> Predicción de Inventario
            </div>
            <div class="card-body">
                <p class="small">Productos que se agotarán pronto basado en el ritmo de ventas actual.</p>
                <ul class="list-group list-group-flush" id="lista-alertas">
                    <li class="list-group-item text-muted">Analizando tendencias...</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Variables globales para los gráficos (para poder destruirlos y redibujarlos)
    let chartVentas = null;
    let chartEstados = null;
    let chartEstaciones = null;

    document.addEventListener('DOMContentLoaded', function() {
        cargarDatosBI();
    });

    async function cargarDatosBI() {
        const periodo = document.getElementById('filtroPeriodo').value;
        
        try {
            // Llamamos a la nueva API con el filtro
            const response = await fetch(`/api/bi-data/?periodo=${periodo}`);
            const data = await response.json();

            // 1. Actualizar Textos KPI
            document.getElementById('bi-ventas').innerText = '$' + parseInt(data.kpis.ventas).toLocaleString('es-CL');
            document.getElementById('bi-pedidos').innerText = data.kpis.pedidos;

            // 2. Gráfico Barras: Top Productos
            actualizarGraficoBarras(data.top_productos);

            // 3. Gráfico Torta: Estados
            actualizarGraficoTorta(data.estados);

            // 4. Gráfico Estacionalidad (NUEVO)
            actualizarGraficoEstaciones(data.estacionalidad);

            // 5. Lista de Predicciones (NUEVO)
            actualizarPredicciones(data.alertas_stock);

        } catch (error) {
            console.error("Error cargando BI:", error);
        }
    }

    function actualizarGraficoBarras(productos) {
        const ctx = document.getElementById('chartVentas').getContext('2d');
        if (chartVentas) chartVentas.destroy(); // Limpiar anterior

        chartVentas = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: productos.map(p => p.nombre),
                datasets: [{
                    label: 'Unidades',
                    data: productos.map(p => p.cantidad),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
    }

    function actualizarGraficoTorta(estadosData) {
        const ctx = document.getElementById('chartEstados').getContext('2d');
        if (chartEstados) chartEstados.destroy();

        // Mapeo de claves a etiquetas bonitas
        const labels = Object.keys(estadosData);
        const values = Object.values(estadosData);

        chartEstados = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: ['#ffcd56', '#36a2eb', '#4bc0c0', '#ff6384', '#9966ff'],
                }]
            }
        });
    }

    function actualizarGraficoEstaciones(estacionData) {
        const ctx = document.getElementById('chartEstaciones').getContext('2d');
        if (chartEstaciones) chartEstaciones.destroy();

        chartEstaciones = new Chart(ctx, {
            type: 'polarArea', // Tipo "Polar" se ve muy pro para comparativas
            data: {
                labels: ['Verano (Dic-Mar)', 'Invierno (Jun-Sep)'],
                datasets: [{
                    data: [estacionData.verano, estacionData.invierno],
                    backgroundColor: [
                        'rgba(255, 205, 86, 0.7)', // Amarillo Verano
                        'rgba(54, 162, 235, 0.7)'  // Azul Invierno
                    ]
                }]
            },
            options: { responsive: true }
        });
    }

    function actualizarPredicciones(alertas) {
        const lista = document.getElementById('lista-alertas');
        lista.innerHTML = ''; // Limpiar

        if (alertas.length === 0) {
            lista.innerHTML = '<li class="list-group-item text-success"><i class="fas fa-check-circle"></i> Niveles de inventario saludables.</li>';
            return;
        }

        alertas.forEach(alerta => {
            lista.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${alerta.producto}</strong><br>
                        <small class="text-danger">${alerta.mensaje}</small>
                    </div>
                    <span class="badge bg-danger rounded-pill">${alerta.stock_actual} left</span>
                </li>
            `;
        });
    }
</script>
{% endblock %}